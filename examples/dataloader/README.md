# Dataloader example

This example demonstrates how to use Graphql plugin with conjunction with Facebook's dataloaders.

Dataloaders are used to reduce the number of queries to the database by batching and caching the requests.
Usually they are used in the GraphQL resolvers when you need to get linked data and want to avoid the N+1 problem.

The example is the same as the base example. The only difference is that we add a table post that has author. It helps us to demonstrate the dataloaders in action on the linked to the posts authors.

We do not show the process of installation and configuration of the plugin. You can find it in the [base example](../dataloader/README.md).

Let's put an emphasis on the differences only.

1. The `migration` folder contains the new migration with the `posts` table creation.
```sql
CREATE TABLE posts (
    id SERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    author_id INT NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```
2. The `storage/query.sql` file contains the `GetPosts` query that selects all posts from the database.
```sql
-- name: GetPosts :many
-- gql: Query.getPosts
SELECT * FROM posts
ORDER BY created_at DESC;
```
3. The `storage/sqlc.yaml` uses the `dataloader` plugin
```yaml
version: '2'
plugins:
  - name: dataloader
    ## The path to the sqlc-dataloader binary
    ## Golang and Graphql plugins described in the base example
    ## ...
sql:
  - engine: "postgresql"
    schema:
     - "migrations"
    queries: "query.sql"

    codegen:
      ## golang and graphql plugins described in the base example
      ## ...
      - plugin: dataloader
        out: "./"
        options:
          ## the package name for the dataloader code
          package: "dataloader"
          sql_package: "pgx/v5"
          ## the full package name pointing to the code generated by golang plugin
          model_import: "dataloader/storage"
```
4. Call the following command to generate the code:
```bash
cd examples/dataloader
sqlc generate -f storage/sqlc.yaml
```
5. The generated code is in the `storage` and `dataloader` folders.
6. It is necessary to add dependencies for the generated code manually. Run the following commands:
```bash
go get github.com/graph-gophers/dataloader/v7
go get github.com/debugger84/sqlc-graphql
```
7. The `graph/resolver/query.resolvers.go` file contains the `GetPosts` resolver where a call of the storage method was added manually.
```go
func (r *queryResolver) GetPosts(ctx context.Context) ([]storage.Post, error) {
	return r.Queries.GetPosts(ctx)
}
```
8. We have added the `graphql/extended.graphql` file where we extend the Post type with the `author` field.
```graphql
extend type Post {
    author: Author! 
}
```
9. The `graph/resolver/extended.resolvesr.go` file contains the `Author` resolver where we use the dataloader to get the author of the post.
```go
func (r *postResolver) Author(ctx context.Context, obj *storage.Post) (storage.Author, error) {
	return r.LoaderFactory.AuthorLoader().Load(ctx, obj.AuthorID)
}
```

So after doing several manual manipulation we links the posts with the authors using the dataloaders. 
Let's apply migrations and run the server and check the result.

```bash
docker run --rm -it --network=host -v "$(pwd)/storage:/db" ghcr.io/amacneil/dbmate -u "postgres://postgres:foobar@localhost:5432/test?sslmode=disable" up
PORT=8081 PG_URI="postgres://postgres:foobar@127.0.0.1:5432/test?sslmode=disable" go run server.go
```

Open the browser and go to the http://localhost:8081/. You will see the GraphQL playground.
Try to add several authors and posts to the database and check the result. 

```graphql
mutation {
    createAuthor(request:{name:"John Doe", bio:"Unknown guy"}) {
        id
        name
    }
}
```

```graphql
mutation {
  createPost(request:{
    title:"The first post", 
    content:"Lorem ipsum", 
    authorId:1
  }){
    id,
    author{id, name, bio}
  }
}
```

As you can see the result of adding a post returns the author of the post. It is done by the dataloader.
```json
{
  "data": {
    "createPost": {
      "id": 1,
      "author": {
        "id": 1,
        "name": "John Doe",
        "bio": "Unknown guy"
      }
    }
  }
}
```